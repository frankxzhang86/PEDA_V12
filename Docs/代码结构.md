# PEDA V12 代码结构文档

## 📁 项目总览

V12采用现代化的模块化架构，实现了关注点分离和高内聚低耦合的设计原则。

```
V12/                                    # 项目根目录
├── 📄 start.py                       # 🚀 主启动入口 (推荐使用)
├── 📄 peda_config.json               # ⚙️ 用户配置文件
├── 📄 requirements.txt               # 📦 依赖管理文件
├── 📄 README.md                      # 📖 项目说明文档
├── 📄 代码结构.md                    # 📋 本架构文档
├── 📄 auto_form_fill_2.py           # 🔄 向后兼容入口
│
├── 📁 config/                        # ⚙️ 配置管理模块
│   ├── __init__.py                   # 包初始化
│   └── constants.py                  # 系统常量和映射配置（文档类别、文件类型过滤等）
│
├── 📁 core/                          # 🏭 核心业务引擎
│   ├── __init__.py                   # 包初始化
│   └── workflow_engine.py            # 主业务流程协调器
│
├── 📁 modules/                       # 🔧 业务功能模块
│   ├── __init__.py                   # 包初始化
│   ├── data_processor.py             # 📊 数据处理模块
│   ├── system_handler.py             # 🔐 系统交互模块
│   ├── form_handler.py               # 📝 表单操作模块
│   ├── document_manager.py           # 📁 文档管理模块
│   ├── pdf_processor.py              # 📄 PDF导航模块
│   ├── pdf_downloader.py             # ⬇️ PDF下载模块
│
├── 📁 interfaces/                    # 🔌 接口层
│   ├── __init__.py                   # 包初始化
│   ├── cli_interface.py              # 💻 命令行接口
│   ├── gui_interface.py              # 🖥️ GUI集成接口
│   └── compat_interface.py           # 🔄 向后兼容接口
│
└── 📁 gui/                           # 🎨 图形用户界面
    ├── __init__.py                   # GUI包初始化
    ├── start_gui.py                  # 🚀 GUI启动脚本
    ├── peda_gui_complete.py          # 🏠 主GUI应用程序
    ├── function_controller.py        # 🎮 功能控制器
    ├── ui_components.py              # 🧩 UI组件管理器
    ├── file_manager.py               # 📂 文件处理模块
    └── languages.py                  # 🌍 多语言支持模块
```

---

## 🚀 启动入口层

### 📄 start.py - 主启动脚本
**角色**: V12独立版本的统一入口点
**特点**: 
- 🎯 单一启动入口，简化用户体验
- 🛡️ 完善的错误处理和用户友好提示
- 📋 清晰的版本信息和功能展示
- 🔧 自动环境检测和依赖验证

```python
# 主要功能:
main()                              # 主入口函数
    ├── 环境检测和路径配置
    ├── 依赖检查和错误处理
    ├── GUI应用启动
    └── 异常捕获和用户提示
```

---

## ⚙️ 配置管理层

### 📁 config/ - 配置管理模块

#### config/constants.py
**功能**: 系统级配置和业务常量管理
```python
# 文档类别与文件类型过滤
DOCUMENT_CATEGORIES = [
    "Image Documentation",
    "Other",
    "Technical Datasheet",
    "Confidential",
    "Measurement Report",
    "Technical Drawing"
]

FILE_TYPE_FILTERS = {
    "Image Documentation": ['.jpg', '.png', '.bmp', '.gif', '.tiff', '.jpeg'],
    "Technical Datasheet": ['.pdf', '.doc', '.docx', '.xlsx', '.xls'],
    "Technical Drawing": ['.dwg', '.dxf', '.pdf'],
    "Measurement Report": ['.xlsx', '.pdf', '.csv', '.xls'],
    "Other": [],
    "Confidential": ['.pdf', '.doc', '.docx']
}
```

---

## 🏭 核心业务层

### 📁 core/ - 核心引擎

#### core/workflow_engine.py
**功能**: 核心业务流程的统一协调器
**设计模式**: 流水线模式 + 策略模式

```python
# 主要函数:
async def run(playwright, data_row, username, password, system_language):
    """
    核心业务流程执行器
    实现完整的自动化处理工作流
    """
    ├── 1. 🔐 系统登录和身份验证
    ├── 2. 🌍 语言环境设置和弹窗处理  
    ├── 3. 🔍 智能产品搜索和定位
    ├── 4. 📝 PEDA表单创建和填写
    ├── 5. 📁 文档分类上传处理
    ├── 6. 💾 数据保存和验证
    ├── 7. 📄 PDF导航和导出
    └── 8. 🛡️ 异常处理和资源清理

# 设计特点:
├── 🔄 异步处理提升性能
├── 🛡️ 完善的错误恢复机制
├── 📊 实时进度反馈
├── 🔍 详细的调试日志
└── 🧩 模块化调用设计
```

---

## 🔧 业务功能层

### 📁 modules/ - 业务模块

#### modules/data_processor.py
**功能**: Excel数据处理和验证
```python
# 主要函数:
def read_excel_data(file_path):
    """Excel数据读取器"""
    ├── 文件格式验证
    ├── 数据完整性检查
    ├── 字段映射处理
    └── 异常数据过滤

def select_excel_file():
    """智能文件选择器"""
    ├── 文件类型过滤
    ├── 路径有效性验证
    └── 用户友好的错误提示
```

#### modules/system_handler.py  
**功能**: 系统交互和会话管理
```python
# 核心功能:
async def set_language_after_login(page):
    """登录后语言环境设置"""
    ├── 自动检测系统语言
    ├── 智能语言切换
    └── 界面适配确认

async def handle_login_popup(page):
    """登录后弹窗处理器"""
    ├── 多种弹窗类型识别
    ├── 自动关闭处理
    └── 超时保护机制

async def enhanced_product_search(page, part_number):
    """增强型产品搜索"""
    ├── 智能搜索策略
    ├── THP类型优先选择
    ├── 模糊匹配处理
    └── 搜索结果验证
```

#### modules/form_handler.py
**功能**: PEDA表单自动化操作
```python
# 核心功能:
async def fill_peda_form(page, data_row):
    """PEDA表单智能填写器"""
    ├── 字段映射和验证
    ├── 数据类型转换
    ├── 必填字段检查
    └── 填写完整性验证

async def save_and_validate_peda(page, part_number, document_manager, data_row):
    """PEDA保存和验证流程"""
    ├── 数据完整性验证
    ├── 自动保存处理
    ├── Cover Sheet跳转
    └── PDF导出集成
```

#### modules/document_manager.py
**功能**: 智能文档管理系统
```python
# 主要类:
class DocumentManager:
    """文档管理器 - 核心文档处理类"""
    
    def __init__(base_path, part_number):
        """初始化文档管理器"""
        ├── 路径规范化处理
        ├── 目录结构验证
        └── 权限检查
    
    def validate_structure():
        """文档结构验证器"""
        ├── 目录层次检查
        ├── 命名规范验证
        └── 完整性评估
    
    def scan_documents():
        """智能文档扫描器"""
        ├── 递归目录遍历
        ├── 文件类型识别
        ├── 大小和格式验证
        └── 重复文件检测
    
    def get_upload_summary():
        """上传摘要生成器"""
        ├── 统计信息汇总
        ├── 错误信息收集
        └── 处理结果报告

# 核心流程函数:
async def process_document_upload(page, document_manager, part_number, data_row):
    """文档上传主流程"""
    ├── 上传前预检查
    ├── 分类批量上传
    ├── 进度实时反馈
    └── 结果验证确认
```

#### modules/pdf_processor.py
**功能**: PDF文档处理和导航
```python
# 主要功能:
async def print_coversheet_pdf_v12(page, part_number, save_dir):
    """PDF处理主入口"""
    ├── PDF页面定位
    ├── 导航路径优化
    ├── 内容验证检查
    └── 导出准备处理

async def find_and_navigate_to_pdf(page):
    """智能PDF导航器"""
    ├── 页面元素识别
    ├── 点击路径优化
    ├── 加载状态监控
    └── 异常情况处理
```

#### modules/pdf_downloader.py
**功能**: PDF文件下载和管理
```python
# 核心功能:
async def handle_pdf_final(page, part_number, save_dir):
    """PDF最终下载处理器"""
    ├── URL提取和验证
    ├── 文件完整性检查
    ├── 断点续传支持
    └── 存储路径管理
```

---

## 🔌 接口抽象层

### 📁 interfaces/ - 接口层

#### interfaces/gui_interface.py
**功能**: GUI和核心业务的桥接器
```python
# 主要函数:
async def run_with_gui_params(**kwargs):
    """GUI参数适配器"""
    ├── 参数标准化处理
    ├── 回调函数绑定
    ├── 进度同步机制
    └── 错误信息传递

# 参数映射:
├── excel_path          -> 数据源文件
├── document_path       -> 文档根目录
├── username/password   -> 认证信息
├── system_language     -> 语言设置
├── progress_callback   -> 进度更新回调
├── log_callback        -> 日志输出回调
└── record_callback     -> 记录管理回调
```

#### interfaces/cli_interface.py
**功能**: 命令行接口支持
```python
# CLI命令支持:
def main():
    """命令行主入口"""
    ├── 参数解析和验证
    ├── 配置文件加载
    ├── 批处理模式支持
    └── 结果输出格式化
```

#### interfaces/compat_interface.py
**功能**: 向后兼容支持
```python
# 兼容性接口:
def legacy_run():
    """旧版本兼容入口"""
    ├── 参数格式转换
    ├── API兼容适配
    └── 迁移提示信息
```

---

## 🎨 用户界面层

### 📁 gui/ - 图形界面

#### gui/peda_gui_complete.py
**功能**: 主GUI应用程序
**设计模式**: MVC架构 + 组件化设计

```python
class PEDAAutomationGUI:
    """主GUI应用类"""
    
    def __init__(self):
        """GUI初始化器"""
        ├── 🎨 界面主题设置
        ├── 🌍 语言环境初始化
        ├── ⚙️ 配置管理器创建
        ├── 📊 状态管理器初始化
        └── 🧩 组件管理器绑定
    
    # 核心方法组:
    ├── setup_variables()      # 界面变量初始化
    ├── setup_styles()         # 现代化样式配置
    ├── init_ui()             # 用户界面构建
    ├── center_window()       # 窗口居中显示
    └── update_time()         # 实时时间更新

# 委托模式设计:
├── 🎮 功能控制 -> FunctionController
├── 🧩 UI组件 -> UIComponentManager  
├── 📂 文件管理 -> FileManager
└── 🌍 语言处理 -> Languages模块
```

#### gui/function_controller.py
**功能**: 业务逻辑控制器
**设计模式**: 控制器模式 + 观察者模式

```python
class FunctionController:
    """功能控制器 - GUI业务逻辑中枢"""
    
    # 🎯 核心控制方法:
    ├── validate_inputs()           # 输入验证控制器
    ├── start_processing()          # 处理流程启动器
    ├── stop_processing()           # 处理流程中断器
    ├── reset_processing()          # 状态重置控制器
    └── run_processing()           # 主处理逻辑执行器
    
    # 📊 进度管理方法:
    ├── update_progress_from_callback()  # 进度回调处理
    ├── log_message_from_callback()     # 日志回调处理
    ├── add_upload_record()             # 上传记录管理
    └── update_stats_display()          # 统计显示更新
    
    # 📥 文档导出方法:
    ├── download_report()          # 处理报告导出
    ├── download_error_log()       # 错误日志导出
    └── download_upload_record()   # 上传记录导出
```

#### gui/ui_components.py
**功能**: UI组件管理器
**设计模式**: 工厂模式 + 建造者模式

```python
class UIComponentManager:
    """UI组件管理器 - 现代化界面构建器"""
    
    # 🏗️ 界面构建方法:
    ├── create_main_container()         # 主容器构建器
    ├── create_header()                 # 顶部标题栏构建器
    ├── create_content_area()           # 内容区域构建器
    └── create_status_bar()             # 状态栏构建器
    
    # 📋 内容区域组件:
    ├── create_login_section()          # 登录信息区域
    ├── create_file_selection_section() # 文件选择区域
    ├── create_operation_control_section() # 操作控制区域
    ├── create_progress_section()       # 进度显示区域
    ├── create_record_management_section() # 记录管理区域
    └── create_log_tab_content()        # 日志面板内容
    
    # 🎨 样式和主题:
    ├── 现代化颜色方案
    ├── 响应式布局设计
    ├── 无障碍访问支持
    └── 多分辨率适配
```

#### gui/file_manager.py
**功能**: 文件处理专用模块
```python
class FileManager:
    """文件管理器 - 专业文件处理类"""
    
    # 📂 文件选择方法:
    ├── choose_excel_file()        # Excel文件选择器
    ├── choose_document_folder()   # 文档目录选择器
    └── validate_all_paths()       # 路径批量验证器
    
    # 📊 数据处理方法:
    ├── read_excel_data()          # Excel数据读取器
    ├── validate_excel_file()      # Excel文件验证器
    └── scan_document_folder()     # 文档目录扫描器
    
    # 🛡️ 安全特性:
    ├── 文件类型白名单过滤
    ├── 路径遍历攻击防护  
    ├── 文件大小限制检查
    └── 权限访问验证
```

#### gui/languages.py
**功能**: 国际化和本地化支持
```python
# 🌍 多语言配置:
LANGUAGES = {
    'en': { /* English translations */ },
    'de': { /* Deutsche Übersetzungen */ },
    'zh': { /* 中文翻译 */ }
}

# 🔧 核心函数:
├── get_text(language_code, key)      # 文本获取器
├── get_available_languages()         # 可用语言列表
├── get_language_display_name()       # 语言显示名称
├── validate_language_code()          # 语言代码验证
└── switch_language_context()         # 语言上下文切换

# 🎯 特色功能:
├── 动态语言切换
├── 缺失翻译回退机制
├── 上下文相关翻译
└── 格式化参数支持
```

---

## 🔄 数据流架构

### 请求处理流程
```
用户操作 -> GUI界面 -> 功能控制器 -> 接口层 -> 核心引擎 -> 业务模块
   ↑                                                          ↓
状态更新 <- 进度回调 <- 接口适配 <- 流程协调 <- 模块执行 <- 具体操作
```

### 配置管理流程
```
应用启动 -> 配置加载 -> 默认值设置 -> 用户修改 -> 实时保存 -> 下次加载
```

### 错误处理流程
```
异常发生 -> 错误捕获 -> 日志记录 -> 用户通知 -> 恢复尝试 -> 优雅降级
```

---

## 🏛️ 设计原则

### 1. 🎯 单一职责原则 (SRP)
- 每个模块只负责一个明确的功能领域
- 避免功能耦合和责任混淆

### 2. 🔓 开放封闭原则 (OCP)  
- 对扩展开放，对修改封闭
- 通过接口和配置实现功能扩展

### 3. 🔄 依赖倒置原则 (DIP)
- 高层模块不依赖低层模块
- 通过抽象接口实现模块解耦

### 4. 🧩 组合优于继承
- 使用组合和委托替代深度继承
- 提高代码的灵活性和可测试性

### 5. 📦 模块化设计
- 清晰的模块边界和接口定义
- 支持独立开发、测试和部署

---

## 🚀 性能优化策略

### 1. 🔄 异步处理
- 核心业务流程采用异步处理
- 避免GUI界面冻结

### 2. 📊 批量操作
- 文档上传采用批量处理
- 减少网络请求次数

### 3. 💾 智能缓存
- 配置信息本地缓存
- 重复数据避免重复处理

### 4. 🛡️ 资源管理
- 自动资源清理和释放
- 内存使用优化

---

## 🔧 扩展指南

### 添加新业务模块
1. 在 `modules/` 下创建新模块文件
2. 实现标准的异步接口
3. 在 `workflow_engine.py` 中集成调用
4. 添加相应的GUI控制组件

### 支持新的界面语言
1. 在 `gui/languages.py` 中添加语言配置
2. 提供完整的翻译文本
3. 测试界面显示效果
4. 更新文档说明

### 自定义UI组件
1. 在 `gui/ui_components.py` 中添加新组件
2. 遵循现有的样式规范
3. 实现响应式布局
4. 添加必要的事件处理

---

*本文档反映V12.0版本的最新架构设计，持续更新中...*
